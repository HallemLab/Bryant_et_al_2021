---
title: "Plots related to Bryant *et al* 20xx"
author: "Astra S. Bryant, PhD"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float: TRUE
    number_sections: true
    fig_caption: TRUE
---

# Introduction/Abstract
This purpose of this document is to generate plots for the mansucript titled 
"The neural basis of temperature-driven host-seeking in the human threadworm *Strongyloides stercoralis*." 

The data analyzed here belong to two different classes of experiments: thermotaxis tracking assays, and thermosensory neuronal imaging experiments. 

## Setup
```{r setup, include=FALSE}
library(knitr)
library(rmarkdown)
library(tidyverse)
library(readxl)
library(magrittr)
library(DescTools)
library(ggthemes)
library(ggpubr)
library(rcartocolor)
library(Cairo)
library(gtools)
library(car)
library(rstatix)
knitr::opts_chunk$set(echo = TRUE)
source("theme_Publication.R")
```

# *Ss-Tax-4* and *strHisCl1* Experiments
These data show the results of the following experimental questions: 

* Role of *Ss-tax-4* in negative thermotaxis behaviors by *S. stercoralis* iL3s
* Effect of chemogenetic inactivation of *Ss*-AFD on positive thermotaxis
* Effect of chemogenetic inactivation of *Ss*-AFD on negative thermotaxis

## Data Inputs
These data were calculated by the TT_WormTracker Matlab code and are imported
into RStudio from the results document generated by Matlab.

* Change in temperature ($^\circ$C)
* Worm speed (mm/s)
* Distance ratio (total distance traveled/max displacement)

For the migration patterns of unstimulated wild-type iL3s, data are from Bryant *et al* 2018 (Current Biology).

```{r message=FALSE}
dat_inactivation_file <- c('../Data/Tax4HisCl1_R_Import.xlsx')

if (is_empty(dat_inactivation_file)){
  dat_inactivation_file <- file.choose()
}
dat_inactivation <- read_excel(dat_inactivation_file, sheet = 1) %>%
  group_by(Experiment,ThermoMode, Phenotype) %>%
  dplyr::mutate(Experiment = factor(Experiment, levels = c("HisCl", "CRISPR", 
                                                         "Unstimulated"))) %>%
  dplyr::mutate(ThermoMode = factor(ThermoMode, levels = c("PT", "NT"))) %>%
  dplyr::mutate(Phenotype = factor(Phenotype, levels = c("BU", "Histamine", 
                                                         "NoCas9", "Ss-tax-4", 
                                                         "Unstimulated"))) 

dat_HisClimaging_file <- c('../Data/AFDHisCl1Imaging_R_Import.xlsx')

if (is_empty(dat_HisClimaging_file)){
  dat_HisClimaging_file <- file.choose()
}
dat_HisClimaging <- read_excel(dat_HisClimaging_file, sheet = 1) %>%
  group_by(Experiment, Phenotype) %>%
  dplyr::mutate(Phenotype = as_factor(Phenotype)) %>%
  dplyr::mutate(Experiment = as_factor(Experiment))

```

## Plot Templates
```{r}
plot_tracking <-  function(dat, y, ylim, xlabel, ylabel, title = NULL, 
                           groupcolors,groupshapes){
  ggplot(data = dat, mapping = aes(x = Phenotype, y = y)) + 
    stat_boxplot(geom = "errorbar", 
                 width = 0.25,
                 size = .5) +
    geom_boxplot(width = 0.5,
                 outlier.shape = NA,
                 fatten = 1,
                 key_glyph = "rect",
                 alpha = 0.3,
                 show.legend = F,
                 aes(fill = Phenotype)) +
    geom_jitter(size = 1,
                stroke = .75,
                width = .2,
                aes(color = Phenotype, shape = Experiment)) +
    scale_y_continuous(limits = ylim, 
                       expand = expansion(add = 0)) +
    scale_color_manual(values = groupcolors,
                       aesthetics = c("colour", "fill")) +
    scale_shape_manual(values = groupshapes)  +
    xlab(xlabel) +
    ylab(ylabel) +
    ggtitle(title) +
    theme_Publication() +
    theme(aspect.ratio = 2/1,
          axis.text.x = element_text(angle= 45,
                                     hjust = 1)) 
}

```

## *Ss*-AFD chemogenetic silencing
Worm: *Sr-gcy-23.2p::strHisCl1* iL3s, with and without treatment with exogenous histamine. For plots of worm speed, unstimulated wild type iL3 data are from Bryant *et al* 2018.

### Positive Thermotaxis
```{r}

p.PT.HisCl.dT<- dat_inactivation %>%
  dplyr::filter(Experiment == "HisCl") %>%
  dplyr::filter(ThermoMode == "PT") %>%
  plot_tracking(dat = ., 
                y = .$dT, 
                ylim = c(-2,6),
                xlabel = NULL,
                ylabel = "dT (C)",
                title = "PT HisCl1: Temp change",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C"),
                groupshapes = 21)

p.PT.HisCl.Speed<- dat_inactivation %>%
  dplyr::filter(Experiment == "HisCl") %>%
  dplyr::filter(ThermoMode == "PT") %>%
  plot_tracking(dat = ., 
                y = .$Speed, 
                ylim = c(0,0.8),
                xlabel = NULL,
                title = "PT HisCl1: Speed",
                ylabel = "Speed (mm/s)",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C"),
                groupshapes = 21)

p.PT.HisCl.Speed2<- dat_inactivation %>%
  dplyr::filter(Experiment == "HisCl" | Experiment == "Unstimulated") %>%
  dplyr::filter(ThermoMode == "PT") %>%
  plot_tracking(dat = ., 
                y = .$Speed, 
                ylim = c(0,0.8),
                xlabel = NULL,
                title = "PT HisCl1: Speed",
                ylabel = "Speed (mm/s)",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C",
                                "Unstimulated" = "#5F6369"),
                groupshapes = c(21, 22))

p.PT.HisCl.DR<- dat_inactivation %>%
  dplyr::filter(Experiment == "HisCl") %>%
  dplyr::filter(ThermoMode == "PT") %>%
  dplyr::filter(Phenotype != "Unstimulated") %>%
  plot_tracking(dat = ., 
                y = .$`Distance Ratio`, 
                ylim = c(0,8),
                xlabel = NULL,
                title = "PT HisCl1: Distance ratio",
                ylabel = "Distance Ratio",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C"),
                groupshapes = 21)

ggarrange(
  p.PT.HisCl.dT,
  p.PT.HisCl.Speed,
  p.PT.HisCl.DR,
  p.PT.HisCl.Speed2,
  ncol = 3,
  nrow = 2
) 

```

### Negative Thermotaxis
```{r}

p.NT.HisCl.dT<- dat_inactivation %>%
  dplyr::filter(Experiment == "HisCl") %>%
  dplyr::filter(ThermoMode == "NT") %>%
  plot_tracking(dat = ., 
                y = .$dT, 
                ylim = c(-4,4),
                xlabel = NULL,
                ylabel = "dT (C)",
                title = "NT HisCl1: Temp change",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C"),
                groupshapes = 21)

p.NT.HisCl.Speed<- dat_inactivation %>%
  dplyr::filter(Experiment == "HisCl") %>%
  dplyr::filter(ThermoMode == "NT") %>%
  plot_tracking(dat = ., 
                y = .$Speed, 
                ylim = c(0,0.3001),
                xlabel = NULL,
                ylabel = "Speed (mm/s)",
                title = "NT HisCl1: Speed",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C"),
                groupshapes = 21)

p.NT.HisCl.DR<- dat_inactivation %>%
  dplyr::filter(Experiment == "HisCl") %>%
  dplyr::filter(ThermoMode == "NT") %>%
  plot_tracking(dat = ., 
                y = .$`Distance Ratio`, 
                ylim = c(0,8),
                xlabel = NULL,
                ylabel = "Distance Ratio",
                title = "NT HisCl1: Distance ratio",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C"),
                groupshapes = 21)

ggarrange(
  p.NT.HisCl.dT,
  p.NT.HisCl.Speed,
  p.NT.HisCl.DR,
  ncol = 3,
  nrow = 1
) 

```

## Calcium imaging of HisCl1-silenced AFD Neurons
Thermosensory response properties of *S. stercoralis* AFD neurons co-expressing *strYC3.60* and *strHisCl1*. 

*Sr-gcy-23.2p::strYC3.60; Sr-gcy-23.2p::strHisCl1::P2A::mRFPmars* iL3s were treated for at least 2 hours with either BU or 50 mM histamine, then exposed to a warming ramp (20-34$^\circ$C ramp; Tambient = 23$^\circ$C).  

### Sum and Max of Absolute Deviation from Baseline
```{r}
p.HisCl.sum<- dat_HisClimaging %>%
  plot_tracking(dat = ., 
                y = .$Sum_AbsDeviation, 
                ylim = c(0,20000),
                xlabel = NULL,
                ylabel = "Sum abs deltaR/R0",
                title = "HisCl1 Imaging: Sum Absolute Deviation",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C"),
                groupshapes = 21)

p.HisCl.max<- dat_HisClimaging %>%
  plot_tracking(dat = ., 
                y = .$Max_AbsDeviation, 
                ylim = c(0,80),
                xlabel = NULL,
                ylabel = "Max abs deltaR/R0",
                title = "HisCl1 Imaging: Max Absolute Deviation",
                groupcolors = c("BU" = "#5F6369", 
                                "Histamine" = "#99772C"),
                groupshapes = 21)

ggarrange(
  p.HisCl.sum,
  p.HisCl.max,
  ncol = 2,
  nrow = 1
) 
```

## *Ss-tax-4* CRISPR/Cas9 KO
CRISPR/Cas9-mediated targeted mutagensis of the *Ss-tax-4* gene. Control worms were not injected with Cas9 plasmid vectors.

### Negative Thermotaxis
```{r}

p.NT.CRISPR.dT<- dat_inactivation %>%
  dplyr::filter(Experiment == "CRISPR") %>%
  dplyr::filter(ThermoMode == "NT") %>%
  plot_tracking(dat = ., 
                y = .$dT, 
                ylim = c(-4,4),
                xlabel = NULL,
                ylabel = "dT (C)",
                title = "NT Ss-tax-4 KO: Temp change",
                groupcolors = c("NoCas9" = "#5F6369", 
                                "Ss-tax-4" = "#1A4C62"),
                groupshapes = 21)

p.NT.CRISPR.Speed<- dat_inactivation %>%
  dplyr::filter(Experiment == "CRISPR") %>%
  dplyr::filter(ThermoMode == "NT") %>%
  plot_tracking(dat = ., 
                y = .$Speed, 
                ylim = c(0,0.3001),
                xlabel = NULL,
                ylabel = "Speed (mm/s)",
                title = "NT Ss-tax-4 KO: Speed",
                groupcolors = c("NoCas9" = "#5F6369", 
                                "Ss-tax-4" = "#1A4C62"),
                groupshapes = 21)

p.NT.CRISPR.DR<- dat_inactivation %>%
  dplyr::filter(Experiment == "CRISPR") %>%
  dplyr::filter(ThermoMode == "NT") %>%
  plot_tracking(dat = ., 
                y = .$`Distance Ratio`, 
                ylim = c(0,25),
                xlabel = NULL,
                ylabel = "Distance Ratio",
                title = "NT Ss-tax-4 KO: Distance ratio",
                groupcolors = c("NoCas9" = "#5F6369", 
                                "Ss-tax-4" = "#1A4C62"),
                groupshapes = 21)

ggarrange(
  p.NT.CRISPR.dT,
  p.NT.CRISPR.Speed,
  p.NT.CRISPR.DR,
  ncol = 3,
  nrow = 1
) 

```

### Group and Save Plots
```{r}
ggarrange(
  p.PT.HisCl.dT,
  p.PT.HisCl.Speed,
  p.PT.HisCl.DR,
  p.NT.CRISPR.dT,
  p.NT.CRISPR.Speed,
  p.NT.CRISPR.DR,
  p.NT.HisCl.dT,
  p.NT.HisCl.Speed,
  p.NT.HisCl.DR,
  p.PT.HisCl.Speed2,
  p.HisCl.sum,
  p.HisCl.max,
  ncol = 3,
  nrow = 4
) %>%
  ggsave(filename ="strHisCl1AndSsTax4Behavior.pdf",
         device = cairo_pdf,
         width = 10.5,
         height = 8.4,
         path = "../Outputs/")
```

# AFD Response Properties
Thermosensory response properties of *C. elegans* AFD (strain = IK890), and *S. stercoralis* AFD (expression plasmid = pASB52). 

The data reflect the responses of *C. elegans* AFD and *S. stercoralis* AFD to the following thermal stimuli:  

+ Warming ramps (Tambient = 23$^\circ$C):  
  - 20-34$^\circ$C ramp (a.k.a "pFPT")
  - 20-40$^\circ$C ramp (a.k.a "pFPTe")
+ Warming ramps (Tambient = 15$^\circ$C): 
  - 12-26$^\circ$C ramp (a.k.a "pFPT")
  - 12-32$^\circ$C ramp (a.k.a "pFPTe")
+ Cooling ramps (Tambient = 23$^\circ$C): 
  - 22-13$^\circ$C ramp (a.k.a "NT")

## Data Inputs
These data were preprocessed and calculated by TCI Matlab code.  
```{r message=FALSE}
dat_AFD_file <- c('../Data/AFDResponse_R_Import.xlsx')

if (is_empty(dat_AFD_file)){
  dat_AFD_file <- file.choose()
}
dat_AFD <- read_excel(dat_AFD_file, sheet = 1) %>%
  group_by(Species,Tambient, Stimulus) %>%
  dplyr::mutate(Species = as_factor(Species)) %>%
  dplyr::mutate(Stimulus = factor(Stimulus, levels = c("pFPT", "pFPTe", "NT"))) %>%
  dplyr::mutate(Tambient = factor(Tambient, levels = c(23, 15)))

dat_AFD_15 <- dplyr::filter(dat_AFD, Tambient == 15) %>%
  dplyr::filter(Stimulus != "NT")

dat_AFD_23 <- dplyr::filter(dat_AFD, Tambient == 23) %>%
  dplyr::filter(Stimulus != "NT")

dat_AFD_allTambient <- dat_AFD %>%
  dplyr::filter(Stimulus != "NT")

```


## Warming stimulus  
Responses of *Ss*-AFD and *Ce*-AFD to thermal stimuli based on the temperatures experienced by *S. stercoralis* iL3s performing postitive thermotaxis in a 20-34C temperature gradient.  In these cases, warming ramp speeds are 0.025C/s.  

### Plot Templates  
```{r AFD_Plot_Templates}

plot_AFD <- function(dat, y, ylim, xlabel, ylabel, stat.test, stat.y.position, title = NULL){
  ggplot(data = dat, mapping = aes(x = Species, y = y)) + 
    stat_boxplot(geom = "errorbar", 
                 width = 0.25,
                 size = .5) +
    geom_boxplot(width = 0.5,
                 outlier.shape = NA,
                 fatten = 1,
                 key_glyph = "rect",
                 alpha = 0.3,
                 show.legend = F,
                 aes(fill = Species)) +
    geom_jitter(size = 1,
                stroke = .75,
                width = .2,
                aes(color = interaction(Species,Stimulus), shape = Stimulus)) +
    stat_pvalue_manual(stat.test, 
                       y.position = stat.y.position,
                       tip.length = 0,
                       bracket.shorten = 0.2,
                       label = 'p.signif') + 
    scale_y_continuous(limits = ylim, 
                       expand = expansion(add = 0)) +
    scale_color_carto_d(palette = "Vivid") +
    scale_fill_carto_d(palette = "Vivid") +
    scale_shape_manual(values = c(21:23))  +
    xlab(xlabel) +
    ylab(ylabel) +
    ggtitle(title) +
    theme_Publication() +
    theme(aspect.ratio = 2/1) 
}


plot_AFD_Speciesfacet <- function(dat, y, ylim, xlabel, ylabel, title = NULL){
  ggplot(data = dat, mapping = aes(x = Tambient, y = y)) + 
    stat_boxplot(geom = "errorbar", 
                 width = 0.25,
                 size = .5) +
    geom_boxplot(width = 0.5,
                 outlier.shape = NA,
                 fatten = 1,
                 key_glyph = "rect",
                 alpha = 0.3,
                 show.legend = F,
                 aes(fill = Species)) +
    geom_jitter(size = 1,
                stroke = .75,
                width = .2,
                aes(color = interaction(Species,Stimulus), shape = Stimulus)) +
    facet_grid(. ~ Species) +
    scale_y_continuous(limits = ylim, 
                       expand = expansion(add = 0)) +
    scale_color_carto_d(palette = "Vivid") +
    scale_fill_carto_d(palette = "Vivid") +
    scale_shape_manual(values = c(21:23))  +
    xlab(xlabel) +
    ylab(ylabel) +
    ggtitle(title) +
    theme_Publication() +
    theme(aspect.ratio = 2/1) 
}
```

### Temperature Threshold  

The temperature threshold for each worm. Threshold is defined as the temperature at which point the caclium response deviates from baseline (F0) response by at least 3 * STD of baseline, for the duration of time it takes for the stimulus ramp to advance 0.25C. For the warming temperature ramps (.025C/s) plotted here, this time is therefore 10 seconds.  

Baseline (F0) responses are defined as the calcium responses at the followin temperatures:  

* For Tambient = 23, F0 = 20C  
* For Tambient = 15, F0 = 12C

Statistics are the results of Wilcoxon signed-rank tests.  

#### Tambient = 23C  

``` {r, message=FALSE}
xlabel <- "Species"
ylabel <- " Temperature (C)"
title <- "Threshold Temperature, Tambient = 23C"
ylim <- c(10, 40)

stat.thresh.23 <- compare_means(Temperature ~ Species, 
                                data = dat_AFD_23,
                                alternative = "two.sided")

p.thresh.23 <- plot_AFD(dat_AFD_23, 
                        dat_AFD_23$Temperature, 
                        ylim,
                        xlabel, 
                        ylabel,
                        stat.thresh.23,
                        38,
                        title)

print(p.thresh.23)
```

#### Tambient = 15C  

``` {r, message=FALSE}
xlabel <- "Ambient Temperature"
ylabel <- " Temperature (C)"
title <- "Threshold Temperature, Tambient = 15C"
ylim <- c(10, 40)


p.thresh.allTc <- plot_AFD_Speciesfacet(dat_AFD_allTambient, 
                                        dat_AFD_allTambient$Temperature, 
                                        ylim,
                                        xlabel, 
                                        ylabel,
                                        title)

print(p.thresh.allTc)
```

### Pearson Correlation  

Is the calcium response above threshold linearly correlated with changes in temperature. Correlation between calcium repsonses and temperature are analyzed across the following temperature ranges:

* For Tambient = 23, from 25 - 34C (pF PT) or 25 - 40C (pF PTe)
* For Tambient = 15, from 17 - 26C (pF PT15) or 17 - 32C (pF PT15e)  

#### Tambient = 23C  

```{r, message=FALSE}

ylabel <- "Pearson's R"
title <- "T vs Ca Correlation, Tambient = 23C"
ylim <- c(-1.5, 1.5)
stat.pearson.23 <- compare_means(AboveThPearsonR ~ Species, 
                                 data = dat_AFD_23,
                                 alternative = "two.sided")

p.pearson.23 <- plot_AFD(dat_AFD_23, 
                         dat_AFD_23$AboveThPearsonR, 
                         ylim,
                         xlabel, 
                         ylabel,
                         stat.pearson.23,
                         1.3,
                         title)

print(p.pearson.23)
```

#### Tambient = 15C  

```{r, message=FALSE}

ylabel <- "Pearson's R"
title <- "T vs Ca Correlation, Tambient = 15C"
ylim <- c(-1.5, 1.5)
xlabel <- "Ambient Temperature"

p.pearson.allTc <- plot_AFD_Speciesfacet(dat_AFD_allTambient, 
                                         dat_AFD_allTambient$AboveThPearsonR, 
                                         ylim,
                                         xlabel, 
                                         ylabel,
                                         title)

print(p.pearson.allTc)
```

### Spearman Correlation  

Is the calcium response near threshold linearly correlated with changes in temperature. Correlation between calcium repsonses and temperature are analyzed across the following temperature ranges:

* For Tambient = 23, from 20 - 25C
* For Tambient = 15, from 12 - 17C  

Statistics are the results of Wilcoxon signed-rank tests. 

#### Tambient = 23C  

```{r, message=FALSE}

ylabel <- "Spearman's R"
xlabel <- "Species"
title <- "T vs Ca Correlation, Tambient = 23C"
ylim <- c(-1.5, 1.5)
stat.spearman.23 <- compare_means(AtThSpearmanR ~ Species, 
                                  data = dat_AFD_23,
                                  alternative = "two.sided")

p.spearman.23 <- plot_AFD(dat_AFD_23, 
                          dat_AFD_23$AtThSpearmanR, 
                          ylim,
                          xlabel, 
                          ylabel,
                          stat.spearman.23,
                          1.3,
                          title)

print(p.spearman.23)
```

#### Tambient = 15C  

```{r, message=FALSE}

ylabel <- "Spearman's R"
title <- "T vs Ca Correlation, Tambient = 15C"
ylim <- c(-1.5, 1.5)
xlabel <- "Ambient Temperature"

p.spearman.allTc <- plot_AFD_Speciesfacet(dat_AFD_allTambient, 
                                          dat_AFD_allTambient$AtThSpearmanR, 
                                          ylim,
                                          xlabel, 
                                          ylabel,
                                          title)

print(p.spearman.allTc)
```


### Temperature eliciting maximal and minimal calcium response  

Plots showing the temperature that corresponds to the maximum and minimal calcium response for each trace.

Statistics are the results of Wilcoxon signed-rank tests. 

#### Max Response  
Only use values from traces from the pFPT stimulus, not the extended versions.  

##### Tambient = 23C
```{r}
ylabel <- "Temperature (C)"
xlabel <- "Species"
title <- "Temp @ Max Response, Tambient = 23C"
ylim <- c(15, 40)

temp_dat <- dplyr::filter(dat_AFD_23, Stimulus == "pFPT")

stat.max.23 <- compare_means(MaximalTemp ~ Species, 
                             data = temp_dat,
                             alternative = "two.sided")

p.max.23 <- plot_AFD(temp_dat, 
                     temp_dat$MaximalTemp, 
                     ylim,
                     xlabel, 
                     ylabel,
                     stat.max.23,
                     38,
                     title)

print(p.max.23)
```

##### Tambient = 15C
```{r}
ylabel <- "Temperature (C)"
xlabel <- "Species"
title <- "Temp @ Max Response, Tambient = 15C"
ylim <- c(10, 35)

temp_dat <- dplyr::filter(dat_AFD_15, Stimulus == "pFPT")

stat.max.15 <- compare_means(MaximalTemp ~ Species, 
                             data = temp_dat,
                             alternative = "two.sided")

p.max.15 <- plot_AFD(temp_dat, 
                     temp_dat$MaximalTemp, 
                     ylim,
                     xlabel, 
                     ylabel,
                     stat.max.15,
                     32,
                     title)

print(p.max.15)
```


#### Min Response

##### Tambient = 23C
```{r}
ylabel <- "Temperature (C)"
xlabel <- "Species"
title <- "Temp @ Min Response, Tambient = 23C"
ylim <- c(15, 40)

stat.min.23 <- compare_means(MinimalTemperature ~ Species, 
                             data = dat_AFD_23,
                             alternative = "two.sided")

p.min.23 <- plot_AFD(dat_AFD_23, 
                     dat_AFD_23$MinimalTemperature, 
                     ylim,
                     xlabel, 
                     ylabel,
                     stat.min.23,
                     38,
                     title)

print(p.min.23)
```

##### Tambient = 15C
```{r}
ylabel <- "Temperature (C)"
xlabel <- "Species"
title <- "Temp @ Min Response, Tambient = 15C"
ylim <- c(10, 35)

stat.min.15 <- compare_means(MinimalTemperature ~ Species, 
                             data = dat_AFD_15,
                             alternative = "two.sided")

p.min.15 <- plot_AFD(dat_AFD_15, 
                     dat_AFD_15$MinimalTemperature, 
                     ylim,
                     xlabel, 
                     ylabel,
                     stat.min.15,
                     32,
                     title)

print(p.min.15)
```


### Group and Save AFD Plots
```{r}
ggarrange(
  p.thresh.23,
  p.thresh.allTc,
  p.min.23,
  p.max.23,
  p.min.15,
  p.max.15,
  p.pearson.23,
  p.spearman.23,
  ncol = 2,
  nrow = 4
) %>%
  ggsave(filename ="AFDResponseWarmingStim.pdf",
         device = cairo_pdf,
         width = 7,
         height = 8.4,
         path = "../Outputs/")
```

## Cooling Stimuli 
Responses of *Ss*-AFD and *Ce*-AFD to cooling thermal ramps based on those commonly used for *C. elegans* experiments (Colon-Ramos lab, in particular). In these cases, cooling ramp speeds are generally -0.1C/s.  

### Response Across Time
```{r, message=FALSE}
dat_cooling_file <- c('../Data/AFDCooling_R_Import.xlsx')

if (is_empty(dat_cooling_file)){
  dat_cooling_file <- file.choose()
}
dat_cooling <- read_excel(dat_cooling_file, sheet = 1) %>%
  dplyr::group_by(Species, Timepoints) %>%
  dplyr::mutate(AnalysisBin = as.factor(Timepoints))
  

ylabel <- "Response"
title <- "Response during cooling ramp"
ylim <- c(-25, 25)
xlim <- c(200, 480)
xbreaks<-c(220, 340, 460)



ggplotRegression <- function (fit) {

require(ggplot2)

ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
    geom_jitter(size = 1,
                stroke = .75,
                width = 5) +
  stat_smooth(method = "lm", col = "red") +
  scale_y_continuous(limits = ylim, 
                       expand = expansion(add = 0)) +
  scale_x_continuous(limits = xlim, 
                     breaks = xbreaks) +
  xlab(xlabel) +
    ylab(ylabel) +
  labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))+
  
    theme_Publication() +
    theme(aspect.ratio = 2/1) 
}

temp.Ce <- dplyr::filter(dat_cooling, Species == "Ce") %>%
  as.data.frame()
p.regression.Ce <- ggplotRegression(lm(temp.Ce$Response ~ temp.Ce$Timepoints, data = temp.Ce))

temp.Ss <- dplyr::filter(dat_cooling, Species == "Ss") %>%
  as.data.frame()

p.regression.Ss <- ggplotRegression(lm(temp.Ss$Response ~ temp.Ss$Timepoints, data = temp.Ss))


linear_regressions <- tibble::tibble(
  bestfit_slope = c(-0.02111, -0.04117),
  bestfit_y_intercept = c(3.586, 6.596),
  bestfit_x_intercept = c(169.8, 160.2),
  Species = as_factor(c('Ce', 'Ss'))
)



p.response.NT <- dat_cooling %>%
  ggplot(mapping = aes(x = Timepoints, y = Response, group = AnalysisBin)) + 
  stat_boxplot(geom = "errorbar", 
                 width = 40,
                 size = .5) +
    geom_boxplot(width = 40,
                 outlier.shape = NA,
                 fatten = 1,
                 key_glyph = "rect",
                 alpha = 0.3,
                 show.legend = F,
                 aes(fill = Species)) +
    geom_jitter(size = 1,
                stroke = .75,
                width = 10, 
                aes(color = AnalysisBin)) +

    facet_grid(. ~ Species) +
    scale_y_continuous(limits = ylim, 
                       expand = expansion(add = 0)) +
  scale_x_continuous(limits = xlim, 
                     breaks = xbreaks) +
    scale_color_carto_d(palette = "Vivid") +
    scale_fill_carto_d(palette = "Vivid") +
    scale_shape_manual(values = c(21:23))  +
    xlab(xlabel) +
    ylab(ylabel) +
    ggtitle(title) +
    theme_Publication() +
    theme(aspect.ratio = 2/1) 
    

print(p.response.NT)

   
```

### Temperatures during timecourse
```{r, message=FALSE}

ylabel <- "Temperature"
title <- "Temperatures during cooling ramp"
ylim <- c(10, 25)

p.temp.NT <-  dat_cooling %>%
  ggplot(mapping = aes(x = Timepoints, y = Temperature, group = AnalysisBin)) + 
  stat_boxplot(geom = "errorbar", 
                 width = 40,
                 size = .5) +
    geom_boxplot(width = 40,
                 outlier.shape = NA,
                 fatten = 1,
                 key_glyph = "rect",
                 alpha = 0.3,
                 show.legend = F,
                 aes(fill = Species)) +
    geom_jitter(size = 1,
                stroke = .75,
                width = 10, 
                aes(color = AnalysisBin)) +
    facet_grid(. ~ Species) +
    scale_y_continuous(limits = ylim, 
                       expand = expansion(add = 0)) +
  scale_x_continuous(limits = xlim, 
                     breaks = xbreaks) +
    scale_color_carto_d(palette = "Vivid") +
    scale_fill_carto_d(palette = "Vivid") +
    scale_shape_manual(values = c(21:23))  +
    xlab(xlabel) +
    ylab(ylabel) +
    ggtitle(title) +
    theme_Publication() +
    theme(aspect.ratio = 2/1)  
  

print(p.temp.NT)
```

### Group and Save AFD Plots
```{r}
ggarrange(
  p.regression.Ce,
  p.regression.Ss,
  p.response.NT,
  p.temp.NT,
  ncol = 2,
  nrow = 3
) %>%
  ggsave(filename ="AFDResponseCoolingStim.pdf",
         device = cairo_pdf,
         width = 7,
         height = 6.3,
         path = "../Outputs/")
```

# U-turn Behaviors  
Worm tracking and calcium imaging data for U-turn behaviors exhibited by *S. stercoralis* iL3s.   

## Data Inputs
Calcium imaging data were preprocessed and calculated by TCI Matlab code. 
```{r message=FALSE}
dat_Uturn_file <- c('../Data/Uturn_R_Import.xlsx')

if (is_empty(dat_Uturn_file)){
  dat_Uturn_file <- file.choose()
}
dat_Uturn <- read_excel(dat_Uturn_file, sheet = 1) %>%
  group_by(Gradient,Tc) %>%
  dplyr::mutate(Gradient = factor(Gradient, levels = c("High", "Low"))) %>%
  dplyr::mutate(Tc = factor(Tc, levels = c(23, 15))) 

```

## Plot Templates
```{r}
plot_Uturn_Range <-  function(dat, y, ylim, xlabel, ylabel, title = NULL){
  ggplot(data = dat, mapping = aes(x = Tc, y = y)) + 
    stat_boxplot(geom = "errorbar", 
                 width = 0.25,
                 size = .5) +
    geom_boxplot(width = 0.5,
                 outlier.shape = NA,
                 fatten = 1,
                 key_glyph = "rect",
                 alpha = 0.3,
                 show.legend = F,
                 aes(fill = Tc)) +
    geom_jitter(size = 1,
                stroke = .75,
                width = .2,
                aes(color = Tc, shape = Gradient)) +
    facet_grid(. ~ Gradient)+
    scale_y_continuous(limits = ylim, 
                       expand = expansion(add = 0)) +
    scale_color_carto_d(palette = "Vivid") +
    scale_fill_carto_d(palette = "Vivid") +
    scale_shape_manual(values = c(21:23))  +
    xlab(xlabel) +
    ylab(ylabel) +
    ggtitle(title) +
    theme_Publication() +
    theme(aspect.ratio = 2/1) 
}

```

## Percent Uturns  
This plot shows the percent of positive thermotaxing worms that engage in Uturn behaviors, for each condition.  

```{r}
p.Uturns.PT <- plot_Uturn_Range(dat_Uturn, 
                                      dat_Uturn$Percent_PT_Reversing, 
                                      ylim = c(-5, 105),
                                      xlabel = "Cultivation Temperature", 
                                      ylabel = "% Reversing", 
                                      title = "% Positive Thermotaxis w/ Uturn")

print(p.Uturns.PT)
```

This plot shows the percent of all worms that engage in Uturn behaviors, for each condition.  
```{r}
p.Uturns.All <- plot_Uturn_Range(dat_Uturn, 
                                       dat_Uturn$Percent_All_Reversing, 
                                       ylim = c(-5, 105),
                                       xlabel = "Cultivation Temperature", 
                                       ylabel = "% Reversing", 
                                       title = "% All Worms w/ Uturn")

print(p.Uturns.All)
```

# AFD Adaptation 
Quantifying the degree of adaptation in steady state *S. stercoralis* AFD response
to different temperatures (either maximum or minimum temperatures in stimulus ramps).

For each condition, response magnitude at two time windows is provided: early (first 15 seconds at temperature) and late (30 seconds - end).  

## Data Inputs
```{r}
dat_adapt_file <- c('../Data/Adaptation_R_Import.xlsx')

if (is_empty(dat_adapt_file)){
  dat_adapt_file <- file.choose()
}
dat_AFD_adaptation <- read_excel(dat_adapt_file, sheet = 1) %>%
  dplyr::mutate(Species = as_factor(Species)) %>%
  dplyr::mutate(Stimulus = factor(Stimulus, levels = c("Uturn", "pFPT", "pFPTe", "NT", "FlincG3"))) %>%
  dplyr::mutate(Tambient = factor(Tambient, levels = c(23, 15))) %>%
  dplyr::mutate(UID = as_factor(UID)) %>%
  pivot_longer(cols = c(AdaptWindowEarly, AdaptWindowLate),
               names_to = "Bin",
               names_prefix = "AdaptWindow",
               values_to = "CaResponse") %>%
  dplyr::mutate(Bin = factor(Bin, levels = c("Early", "Late"))) %>%
  dplyr::mutate(Dir_late = factor(case_when(
    AdaptWindowLate_Cat > 0 ~ "Sig Diff",
    AdaptWindowLate_Cat < 0 ~ "Sig Diff",
    AdaptWindowLate_Cat == 0 ~ "Not Sig"),
    levels = c("Sig Diff", "Not Sig"))) %>%
  dplyr::mutate(Dir_early = factor(case_when(
    AdaptWindowEarly_Cat > 0 ~ "Sig Diff",
    AdaptWindowEarly_Cat < 0 ~ "Sig Diff",
    AdaptWindowEarly_Cat == 0 ~ "Not Sig"),
    levels = c("Sig Diff", "Not Sig"))) %>%
  group_by(Species,Tambient, Stimulus, UID)

```

## Steady-state
This should reveal any adaptation in the response once temperature is holding at the steady state temperature (for variable lengths of time).

### Neural Response Across T(max)
```{r}
xlabel <- "TimingWindow"
ylabel <- "Median Response, normalized to Tambient"
title <- "Neural Response as a function of time during stead-state temp"
ylim <- c(-50, 50)

p.Tmax.adapt <- dat_AFD_adaptation %>%
  ggplot(mapping = aes(x = Bin, y = CaResponse)) + 
  stat_boxplot(geom = "errorbar", 
               width = 0.25,
               size = .5) +
  geom_boxplot(width = 0.5,
               outlier.shape = NA,
               fatten = 1,
               key_glyph = "rect",
               alpha = 0.3,
               show.legend = F,
               aes(fill = Bin)) +
  geom_jitter(size = 1,
              stroke = .75,
              width = .2,
              aes(color = Bin, shape = Stimulus)) +
  facet_grid(. ~ Stimulus)+
  scale_y_continuous(limits = ylim, 
                     expand = expansion(add = 0)) +
  scale_color_carto_d(palette = "Vivid") +
  scale_fill_carto_d(palette = "Vivid") +
  scale_shape_manual(values = c(21:23,21,21))  +
  xlab(xlabel) +
  ylab(ylabel) +
  ggtitle(title) +
  theme_Publication() +
  theme(aspect.ratio = 2/1) 

print(p.Tmax.adapt)
```


### Categorical
Plotting the proportion of traces belonging to one of two categories: those in which the response is significantly different from the response at the cultivation/holding temperature, and those where the response is not significantly different.  

Categorical identities for each trace were calculated in Matlab.  
```{r}

xlabel <- "Stimulus"
ylabel <- "Proportion of Worms"
title <- "Deviation of Calcium Trace from Holding Response"

p.bar.adapt.late <- dat_AFD_adaptation %>%
  dplyr::filter(Stimulus != "NT" & Stimulus != "FlincG3") %>%
  ggplot(mapping = aes(x = Stimulus)) + 
  geom_bar(aes(fill = Dir_late), position = "fill") +
  scale_color_manual(values = c("Not Sig" = "#5F6369", 
                                "Sig Diff" = "coral4"),
                     aesthetics = c("colour", "fill")) +
  xlab(xlabel) +
  ylab(ylabel) +
  ggtitle(title) +
  theme_Publication() +
  theme(aspect.ratio = 2/1) 

print(p.bar.adapt.late)

```


## Group and Save Plots
```{r}
ggarrange(
  p.Uturns.PT,
  p.Uturns.All,
  p.bar.adapt.late,
  p.Tmax.adapt,
  ncol = 2,
  nrow = 4
) %>%
  ggsave(filename ="UturnBehaviorAndAFDAdaptation.pdf",
         device = cairo_pdf,
         width = 7,
         height = 8.4,
         path = "../Outputs/")
```

# Ss-AFD-rGC Ecoptic Expression Analysis
Analysis and plotting for a series of experiments testing the effect of 
misepxresion of *Ss-gcy-23.1*, *Ss-gcy-23.2*, and *Ss-gcy-23.3* in *C. elegans* ASE neurons, in response to the pseudo-fictive PTe 20-40$^\circ$C ramp.   

## Data Inputs
Data are preprocessed using Matlab TCI file `TCI_analyzeEctopic.m`, which calculates the temperature at which point an experimental trace rises above 3*rms of mean control trace for at least 6 seconds. 

This calculation is run independently for each trace, and the value (in $^\circ$C)
is saved.

```{r message=FALSE}
dat_ectopic_file <- c('../Data/EctopicExpression_R_Import.xlsx')
if (is_empty(dat_ectopic_file)){
  dat_ectopic_file <- file.choose()
}
meta_ectopic <-read_excel(dat_ectopic_file, sheet = "Metadata")
dat_ectopic <- read_excel(dat_ectopic_file, sheet = 1) %>%
  group_by(rGC,Strain)

dat_ectopic_filtered <- dat_ectopic %>%
  dplyr::filter(rGC != "ASE_ctrl") %>%
  dplyr::filter(!is.na(Thresh_temp)) %>%
  dplyr::bind_rows(dplyr::filter(dat_ectopic, rGC == "ASE_ctrl"))
```

## rGC Plot Templates 

```{r}
source("theme_Publication.R")

plot_ectopic_noctrl <- function(dat, y, meta, ylim, xlabel,
                                ylabel, stat.test, 
                                stat.y.position,
                                title = NULL){
  ggplot(data = dat, mapping = aes(x = rGC, y = y)) + 
    
    stat_boxplot(geom = "errorbar", 
                 width = 0.25,
                 size = 0.5) +
    geom_boxplot(width = 0.5,
                 outlier.shape = NA,
                 fatten = 1,
                 key_glyph = "rect",
                 alpha = 0.3,
                 aes(fill = rGC)) +
    geom_jitter(size = 2,
                stroke = .75,
                width = .2,
                aes(color = Strain, shape = Strain)) +
    stat_pvalue_manual(stat.test, 
                       y.position = stat.y.position,
                       step.increase = 0.1,
                       tip.length = 0,
                       hide.ns = TRUE,
                       bracket.shorten = 0.2,
                       label = "p.adj.signif"
    ) + 
    scale_y_continuous(limits = ylim, 
                       expand = expansion(add = 0)) +
    xlab(xlabel) +
    ylab(ylabel) +
    ggtitle(title) +
    scale_fill_manual(values = c("darkorchid4", "cyan4", "coral4"))+
    scale_color_manual(values = c(rep(c("darkorchid4","cyan4", "coral4"),each = 3)))+
    scale_shape_manual(values = rep(c(21:23), 3))  +
    theme_Publication() +
    theme(aspect.ratio = 4/3,
          axis.text.x = element_text(angle= 45,
                                     
                                     hjust = 1)) 
}
```


## Temperature Threshold  
Stats are Kruskal-Wallis Test with Dunn's Post tests for difference in response amplitude.  
``` {r}
# ---- Temperature Threshold Plot ----

xlabel <- "Ss-AFD-rGCs"
ylabel <- " Temperature (C)"
title <- "Threshold Temperature"
ylim <- c(19, 42)

dat.subset <-dplyr::filter(dat_ectopic_filtered, rGC != "ASE_ctrl")%>%
  dplyr::mutate(Strain = as_factor(Strain)) %>%
  dplyr::mutate(rGC = as_factor(rGC))

# Kruskal-Wallis testing of response amplitude differenec
one.way <- kruskal.test(Thresh_temp ~ rGC, 
                        data = dat.subset)

# Posthoc Dunn tests with Bonferroni adjustment
post.hoc <- dunn.test::dunn.test(dat.subset$Thresh_temp, 
                                 dat.subset$rGC, 
                                 method = "bonferroni",
                                 table = FALSE,
                                 list = TRUE)

stat.test.ectopic.thresh <- dplyr::tibble(
  comparisons = post.hoc$comparisons,
  p.adj = post.hoc$P.adjusted,
  p.adj.signif = stars.pval(post.hoc$P.adjusted)
) %>%
  mutate(p.adj.signif = case_when(p.adj.signif == " " ~ "ns",
                                  TRUE ~ as.character(p.adj.signif))) %>%
  tidyr::separate(comparisons, 
                  into = c("group1", "group2"),
                  sep = " - ")

p_ectopic_thresh<- plot_ectopic_noctrl(dat.subset, 
                                       dat.subset$Thresh_temp, 
                                       meta_ectopic,
                                       ylim,
                                       xlabel, 
                                       ylabel,
                                       stat.test.ectopic.thresh,
                                       41,
                                       title)


print(p_ectopic_thresh)


```

## Temperature driving maximum response  

Stats are Kruskal-Wallis Test with Dunn's Post tests for difference in response amplitude.  
```{r}
# Kruskal-Wallis testing of response amplitude differenec
one.way <- kruskal.test(Tmax ~ rGC, 
                        data = dat.subset)

# Posthoc Dunn tests with Bonferroni adjustment
post.hoc <- dunn.test::dunn.test(dat.subset$Tmax, 
                                 dat.subset$rGC, 
                                 method = "bonferroni",
                                 table = FALSE,
                                 list = TRUE)

xlabel <- "Ss-AFD-rGCs"
ylabel <- "Temperature (deg C)"
title <- "Temperature driving max calcium response"
ylim <- c(19,42)

stat.test.ectopic.Tmax <- dplyr::tibble(
  comparisons = post.hoc$comparisons,
  p.adj = post.hoc$P.adjusted,
  p.adj.signif = stars.pval(post.hoc$P.adjusted)
) %>%
  mutate(p.adj.signif = case_when(p.adj.signif == " " ~ "ns",
                                  TRUE ~ as.character(p.adj.signif))) %>%
  tidyr::separate(comparisons, 
                  into = c("group1", "group2"),
                  sep = " - ")

p_Tmax<- plot_ectopic_noctrl(dat.subset, 
                             dat.subset$Tmax, 
                             meta_ectopic,
                             ylim,
                             xlabel, 
                             ylabel,
                             stat.test.ectopic.Tmax,
                             42,
                             title)

print(p_Tmax)
```

## Group and Save Ectopic Plots
```{r}
ggarrange(
  p_ectopic_thresh,
  p_Tmax, 
  ncol = 2,
  nrow = 1
) %>%
  ggsave(filename ="EctopicrGCExpression.pdf",
         device = cairo_pdf,
         width = 7,
         # height = 3.5,
         path = "../Outputs/")
```


